<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†è´§å¸ä»£å¸åˆ—è¡¨ - æ··åˆæ•°æ®æº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼•å…¥ Inter å­—ä½“ä»¥è·å¾—ç°ä»£æ„Ÿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* æ·±è‰²èƒŒæ™¯ */
            color: #c9d1d9; /* æµ…è‰²æ–‡æœ¬ */
        }
        /* è¡¨æ ¼æ‚¬åœæ•ˆæœ */
        .token-row:hover {
            background-color: #161b22;
        }
        /* æ¶¨è·Œå¹…ç™¾åˆ†æ¯”æ ·å¼ */
        .percent-up { color: #48bb78; } /* ç»¿è‰² */
        .percent-down { color: #f56565; } /* çº¢è‰² */

        /* ç»Ÿä¸€çš„æ•°å­—æ ·å¼åŸºç¡€ç±» - ä¿®æ”¹ï¼štext-right æ”¹ä¸º text-left */
        .finance-data {
             /* ç»Ÿä¸€ä½¿ç”¨ font-mono, text-sm, font-semibold */
            @apply text-sm text-left font-mono font-semibold whitespace-nowrap;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ (å¯é€‰) */
        select option {
            background-color: #1f2937;
            color: white;
        }
        /* éšè—ç±»ï¼Œç”¨äºåˆ‡æ¢æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡† */
        .hidden-custom {
            display: none !important;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-8 p-4 bg-[#161b22] rounded-xl shadow-lg">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-400 mb-2">ä»£å¸å¸‚åœºæ•°æ®å¢å¼ºåˆ—è¡¨</h1>
            <p class="text-gray-400 text-sm sm:text-base">åˆ—è¡¨å·²è¿‡æ»¤è‡³ **Binance USDT å¸‚åœº** çš„ä»£å¸ã€‚ä»·æ ¼/è·Œå¹…æ¯”ï¼šBinance API & CoinGecko ATH | å…¶ä»–æ•°æ®ï¼šBinance/CoinGecko æ··åˆæº (å‰ 1000 ä»£å¸å·²å®ç° 4 å°æ—¶è‡ªåŠ¨åˆ·æ–°)</p>
        </header>

        <div class="flex flex-col sm:flex-row gap-4 mb-6 sm:justify-end items-center flex-wrap">
            
            <div class="flex gap-2 w-full sm:w-auto items-center">
                <select id="rank-range-select" onchange="handleRankRangeChange()" 
                        class="p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition duration-150 flex-grow sm:w-48 cursor-pointer">
                    <option value="all">ğŸ† æ‰€æœ‰æ’å</option>
                    <option value="1-100">Top 1 - 100</option>
                    <option value="101-200">Top 101 - 200</option>
                    <option value="201-300">Top 201 - 300</option>
                    <option value="301-400">Top 301 - 400</option>
                    <option value="401-500">Top 401 - 500</option>
                    <option value="501-1000">Top 501 - 1000</option>
                    <option value="custom">ğŸ›  è‡ªå®šä¹‰èŒƒå›´...</option>
                </select>

                <div id="custom-range-inputs" class="hidden-custom flex gap-2 items-center">
                    <input type="number" id="custom-min" placeholder="Min" class="w-20 p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:ring-blue-500 text-left text-sm">
                    <span class="text-gray-400">-</span>
                    <input type="number" id="custom-max" placeholder="Max" class="w-20 p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:ring-blue-500 text-left text-sm">
                    <button onclick="applyCustomRank()" class="p-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm transition">OK</button>
                </div>
            </div>

            <input type="text" id="search-input" placeholder="æœç´¢ä»£å¸åç§°æˆ–ç¬¦å·..."
                   class="p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:w-80 w-full">
            
            <div class="flex gap-3 w-full sm:w-auto">
                <button class="w-full sm:w-auto px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 whitespace-nowrap" onclick="fetchDataAndRender()">
                    <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.412 8.59l.617-.618m-.617.618a8.002 8.002 0 01-14.735 0M9 14l-2 2 2 2"></path></svg>
                    ç«‹å³åˆ·æ–°
                </button>
            </div>
        </div>

        <div class="bg-[#161b22] rounded-xl overflow-x-auto shadow-xl">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-800 sticky top-0">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('rank')"># æ’å</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('name')">åç§°</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('priceUSD')">ä»·æ ¼ (USD)</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('ath')">å†å²æœ€é«˜ (ATH)</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('dropFromAthPercent')">è·Œå¹…æ¯” (ATH)</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('volume24hUSD')">24H äº¤æ˜“é‡</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('priceChangePercent24h')">24H æ¶¨è·Œå¹…</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('circulatingMarketCapUSD')">æµé€šå¸‚å€¼</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('turnoverRate')">æ¢æ‰‹ç‡</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer hover:text-white hover:bg-gray-700 transition" onclick="sortData('sector')">æ¿å— (èµ›é“)</th>
                    </tr>
                </thead>
                <tbody id="token-list-body" class="divide-y divide-gray-700">
                    <tr><td colspan="10" class="p-8 text-center text-gray-500">æ­£åœ¨åŠ è½½æ•°æ®...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div id="pagination-controls" class="flex justify-center items-center gap-2 mt-6 p-4 bg-[#161b22] rounded-xl">
            </div>
        <footer class="mt-8 text-center p-4">
            <p class="text-xs text-gray-500">ä»·æ ¼/24Häº¤æ˜“é‡æºè‡ª Binance APIï¼›**è·Œå¹…æ¯” (ATH)** ç”± Binance ä»·æ ¼å’Œ CoinGecko å†å²æœ€é«˜ä»·è®¡ç®—å¾—å‡º (**ç¨³å®šå¸å·²æ’é™¤**)ã€‚æµé€šå¸‚å€¼ = CoinGeckoæµé€šä¾›åº”é‡ * Binanceä»·æ ¼ï¼›æ¢æ‰‹ç‡ï¼ˆç¨³å®šå¸é™¤å¤–ï¼‰åŸºäº Binance äº¤æ˜“é‡å’Œè®¡ç®—å¸‚å€¼ï¼›24Hæ¶¨è·Œå¹…æºè‡ª CoinGecko APIã€‚</p>
            <p class="text-xs text-gray-500 mt-2">**æ¿å— (èµ›é“) æ•°æ®ç‰¹åˆ«è¯´æ˜ï¼š** æ­¤å­—æ®µä½¿ç”¨æˆ‘ä»¬æ‰‹åŠ¨ç»´æŠ¤çš„ã€å‚è€ƒ **RootData** èµ›é“åˆ†ç±»æ ‡å‡†æ•´ç†çš„ **é¢„è®¾æ˜ å°„è¡¨** (SECTOR_MAP) è¿›è¡Œå±•ç¤ºã€‚ç”±äºæµè§ˆå™¨å®‰å…¨ç­–ç•¥ï¼ˆCORSï¼‰é™åˆ¶ä»¥åŠå¤–éƒ¨å¹³å°å®˜æ–¹ API Key çš„è¦æ±‚ï¼Œæˆ‘ä»¬æ— æ³•åœ¨å‰ç«¯ç›´æ¥è·å–å®æ—¶æ ‡ç­¾æ•°æ®ã€‚</p>
        </footer>
    </div>

    <script type="text/javascript">
        // Binance API URL
        const BINANCE_PRICE_API_URL = 'https://api.binance.com/api/v3/ticker/price';
        const BINANCE_24HR_TICKER_API_URL = 'https://api.binance.com/api/v3/ticker/24hr';


        // åˆå§‹æ’åºè®¾ç½®ä¸º æ’åå‡åº
        let currentSort = { column: 'rank', direction: 'asc' }; 
        let allTokens = [];
        let refreshIntervalId = null;
        
        // åˆ†é¡µçŠ¶æ€
        let currentPage = 1;
        const itemsPerPage = 100;
        
        // æ’åèŒƒå›´ç­›é€‰çŠ¶æ€ï¼Œé»˜è®¤ä¸º 'all'
        let currentRankRange = 'all';

        // é¢„å®šä¹‰ä¸»è¦ä»£å¸çš„æ¿å—/èµ›é“ä¿¡æ¯ (ç»´æŒåŸæ ·)
        const SECTOR_MAP = {
            'BTC': 'L1 / ä»·å€¼å­˜å‚¨', 'ETH': 'L1 / æ™ºèƒ½åˆçº¦', 'BNB': 'äº¤æ˜“æ‰€ç”Ÿæ€', 'SOL': 'é«˜æ€§èƒ½L1', 'ADA': 'æ™ºèƒ½åˆçº¦å¹³å°',
            'AVAX': 'L1 / æ™ºèƒ½åˆçº¦', 'NEAR': 'L1 / æ¨¡å—åŒ–', 'DOT': 'è·¨é“¾ / Polkadot', 'ATOM': 'è·¨é“¾ / Cosmos', 'TRX': 'åŸºç¡€è®¾æ–½ / L1', 
            'XRP': 'æ”¯ä»˜ / è·¨å¢ƒè½¬è´¦', 'LTC': 'ä»·å€¼å­˜å‚¨ / è€ç‰Œå¸', 'ETC': 'ä¼ ç»ŸL1', 'TON': 'L1 / é€šä¿¡', 'APT': 'L1 / Moveè¯­è¨€',
            'HBAR': 'ä¼ä¸šçº§ / DAG', 'XMR': 'éšç§å¸', 'ALGO': 'L1 / æœºæ„çº§', 'FTM': 'L1 / DAG', 'EGLD': 'L1 / åˆ†ç‰‡',
            'MATIC': 'L2 / ä¾§é“¾/æ‰©å®¹', 'OP': 'L2 / Optimism', 'ARB': 'L2 / Arbitrum', 'STRK': 'L2 / ZK Rollup', 'IMX': 'L2 / Gaming',
            'METIS': 'L2 / Optimistic', 'CELO': 'L2 / ç§»åŠ¨ä¼˜å…ˆ',
            'UNI': 'DeFi / DEX', 'AAVE': 'DeFi / å€Ÿè´·', 'MKR': 'DeFi / DAO', 'COMP': 'DeFi / å€Ÿè´·', 'CRV': 'DeFi / DEX',
            'DYDX': 'DeFi / æ°¸ç»­åˆçº¦DEX', 'CAKE': 'DeFi / DEX (BSC)', 'LDO': 'DeFi / LSD', 'SSV': 'DeFi / DVT', 'PENDLE': 'DeFi / æ”¶ç›Šç‡äº¤æ˜“',
            'LINK': 'é¢„è¨€æœº (Oracle)', 'BAND': 'é¢„è¨€æœº', 'GRT': 'æ•°æ® / ç´¢å¼•', 'OCEAN': 'æ•°æ®å¸‚åœº', 'HNT': 'DePIN / IoT',
            'FIL': 'å»ä¸­å¿ƒåŒ–å­˜å‚¨', 'AR': 'å»ä¸­å¿ƒåŒ–å­˜å‚¨', 'BTT': 'å»ä¸­å¿ƒåŒ–å­˜å‚¨/å†…å®¹',
            'RNDR': 'AI / æ¸²æŸ“è®¡ç®—', 'FET': 'AI / æœºå™¨å­¦ä¹ ', 'AGIX': 'AI / æ™ºèƒ½æœåŠ¡', 'WLD': 'èº«ä»½éªŒè¯ / AI', 'ICP': 'å»ä¸­å¿ƒåŒ–è®¡ç®—',
            'AXS': 'P2E æ¸¸æˆ', 'SAND': 'å…ƒå®‡å®™ / æ¸¸æˆ', 'MANA': 'å…ƒå®‡å®™ / æ¸¸æˆ', 'APE': 'NFT ç”Ÿæ€ / DAO', 'GALA': 'æ¸¸æˆç”Ÿæ€',
            'ENJ': 'æ¸¸æˆ / NFT', 'RON': 'æ¸¸æˆä¾§é“¾',
            'DOGE': 'Meme', 'SHIB': 'Meme / ç¤¾åŒº', 'PEPE': 'Meme', 'WIF': 'Meme', 'FLOKI': 'Meme',
            'ONDO': 'RWA / ç¨³å®šå¸', 'CFG': 'RWA / å€Ÿè´·', 'POLYX': 'RWA / è¯åˆ¸å‹ä»£å¸',
            'USDT': 'ç¨³å®šå¸', 'USDC': 'ç¨³å®šå¸', 'DAI': 'ç¨³å®šå¸ / å»ä¸­å¿ƒåŒ–',
        };

        function formatCurrency(num) {
            if (num === null || isNaN(num) || num === undefined) return 'N/A';
            return new Intl.NumberFormat('en-US', {
                style: 'currency', currency: 'USD', minimumFractionDigits: (num < 1 && num !== 0) ? 4 : 2, maximumFractionDigits: (num < 1 && num !== 0) ? 8 : 2,
            }).format(num);
        }

        function formatCompact(num) {
            if (num === null || isNaN(num) || num === 0 || num === undefined) return '$0';
            const units = [{ value: 1e12, symbol: "T" }, { value: 1e9, symbol: "B" }, { value: 1e6, symbol: "M" }];
            for (const unit of units) {
                if (num >= unit.value) return '$' + (num / unit.value).toFixed(2).replace(/\.0$/, '') + unit.symbol;
            }
            return formatCurrency(num);
        }

        async function fetchCoingeckoPage(page) {
            const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=${page}&sparkline=false`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`CoinGecko API (Page ${page}) Error: ${response.status}`);
            return response.json();
        }

        async function fetchBinancePrices() {
            try {
                const response = await fetch(BINANCE_PRICE_API_URL);
                if (!response.ok) throw new Error("Binance API Error");
                const rawData = await response.json();
                const priceMap = new Map();
                rawData.forEach(ticker => {
                    if (ticker.symbol.endsWith('USDT')) priceMap.set(ticker.symbol.replace('USDT', ''), parseFloat(ticker.price));
                });
                return priceMap;
            } catch (error) { console.error(error); return new Map(); }
        }

        async function fetchBinance24hrVolume() {
            try {
                const response = await fetch(BINANCE_24HR_TICKER_API_URL);
                if (!response.ok) throw new Error("Binance API Error");
                const rawData = await response.json();
                const volumeMap = new Map();
                rawData.forEach(ticker => {
                    if (ticker.symbol.endsWith('USDT')) volumeMap.set(ticker.symbol.replace('USDT', ''), parseFloat(ticker.quoteVolume));
                });
                return volumeMap;
            } catch (error) { console.error(error); return new Map(); }
        }

        async function fetchTokenData() {
            console.log("Fetching Data...");
            const STABLECOIN_SYMBOLS = ['USDT', 'USDC', 'DAI', 'BUSD', 'TUSD', 'USDP', 'FRAX', 'GUSD', 'PAXG', 'EURS', 'USTC', 'FDUSD'];

            const [cgPage1, cgPage2, cgPage3, cgPage4, binancePriceMapResult, binanceVolumeMapResult] = await Promise.allSettled([
                fetchCoingeckoPage(1), fetchCoingeckoPage(2), fetchCoingeckoPage(3), fetchCoingeckoPage(4), 
                fetchBinancePrices(), fetchBinance24hrVolume()
            ]);
            
            const rawCoinGeckoData = [cgPage1, cgPage2, cgPage3, cgPage4]
                .filter(res => res.status === 'fulfilled')
                .flatMap(res => res.value);
                
            const binancePriceMap = binancePriceMapResult.status === 'fulfilled' ? binancePriceMapResult.value : new Map();
            const binanceVolumeMap = binanceVolumeMapResult.status === 'fulfilled' ? binanceVolumeMapResult.value : new Map();

            if (rawCoinGeckoData.length === 0) throw new Error("No data from CoinGecko.");

            let filteredCoinGeckoData = rawCoinGeckoData.filter(token => binancePriceMap.has(token.symbol.toUpperCase()));
            
            filteredCoinGeckoData = filteredCoinGeckoData.filter(token => {
                const tokenNameLower = token.name.toLowerCase();
                return !(tokenNameLower.includes('bridged') || tokenNameLower.includes('binance-peg') || tokenNameLower.includes('wrapped'));
            });
            
            return filteredCoinGeckoData.map((token) => {
                const symbolUpper = token.symbol.toUpperCase();
                const finalPrice = binancePriceMap.get(symbolUpper);
                const circulatingSupply = token.circulating_supply;
                let calculatedMarketCapUSD = null;
                if (finalPrice !== undefined && circulatingSupply !== undefined && circulatingSupply !== null) {
                    calculatedMarketCapUSD = circulatingSupply * finalPrice;
                }
                const binanceVolume = binanceVolumeMap.get(symbolUpper);
                const volume24h = binanceVolume !== undefined ? binanceVolume : (token.total_volume || 0);

                let turnoverRate = null;
                if (!STABLECOIN_SYMBOLS.includes(symbolUpper) && calculatedMarketCapUSD > 0 && volume24h > 0) {
                    turnoverRate = (volume24h / calculatedMarketCapUSD) * 100;
                    if (isNaN(turnoverRate) || !isFinite(turnoverRate)) turnoverRate = 0;
                }
                
                const priceChangePercent24h = token.price_change_percentage_24h;
                const ath = token.ath;
                let dropFromAthPercent = null;
                if (!STABLECOIN_SYMBOLS.includes(symbolUpper) && ath && ath > 0 && finalPrice !== null) {
                    dropFromAthPercent = ((ath - finalPrice) / ath) * 100; 
                    if (dropFromAthPercent < 0) dropFromAthPercent = 0; 
                }
                
                return {
                    rank: token.market_cap_rank,
                    name: token.name, 
                    symbol: symbolUpper,
                    priceUSD: finalPrice, 
                    ath: ath, 
                    dropFromAthPercent: dropFromAthPercent, 
                    volume24hUSD: volume24h, 
                    priceChangePercent24h: priceChangePercent24h, 
                    circulatingMarketCapUSD: calculatedMarketCapUSD, 
                    turnoverRate: turnoverRate, 
                    sector: SECTOR_MAP[symbolUpper] || 'N/A', 
                    image: token.image 
                };
            }).filter(token => token.rank !== null);
        }

        function sortData(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = (['rank', 'name', 'symbol', 'sector'].includes(column)) ? 'asc' : 'desc'; 
            }
            
            const toSortableValue = (val, col) => {
                if (val === null || val === undefined) {
                    if (col === 'rank' || col === 'volume24hUSD' || col === 'circulatingMarketCapUSD' || col === 'priceUSD') return currentSort.direction === 'asc' ? Infinity : -Infinity;
                    if (typeof val === 'number') return isNaN(val) ? 0 : val;
                    return col === 'sector' ? 'N/A' : '';
                }
                if (typeof val === 'number') return isNaN(val) ? 0 : val;
                return val;
            };

            allTokens.sort((a, b) => {
                let aVal = toSortableValue(a[column], column);
                let bVal = toSortableValue(b[column], column);
                
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    let comparison = aVal.localeCompare(bVal);
                    return currentSort.direction === 'asc' ? comparison : comparison * -1;
                }
                let comparison = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                return currentSort.direction === 'asc' ? comparison : comparison * -1;
            });

            renderTable(allTokens);
        }

        // ä¿®æ”¹ï¼šå¤„ç†æ’åèŒƒå›´å˜åŒ–çš„å‡½æ•°ï¼Œå¢åŠ è‡ªå®šä¹‰é€»è¾‘
        function handleRankRangeChange() {
            const selectElement = document.getElementById('rank-range-select');
            const customInputContainer = document.getElementById('custom-range-inputs');
            
            if (selectElement.value === 'custom') {
                // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡†
                customInputContainer.classList.remove('hidden-custom');
            } else {
                // éšè—è‡ªå®šä¹‰è¾“å…¥æ¡†å¹¶åº”ç”¨é¢„è®¾å€¼
                customInputContainer.classList.add('hidden-custom');
                currentRankRange = selectElement.value;
                currentPage = 1; 
                renderTable(allTokens);
            }
        }

        // æ–°å¢ï¼šåº”ç”¨è‡ªå®šä¹‰èŒƒå›´
        function applyCustomRank() {
            const minInput = document.getElementById('custom-min').value;
            const maxInput = document.getElementById('custom-max').value;
            
            const min = parseInt(minInput) || 1;
            const max = parseInt(maxInput) || 10000;
            
            if (min > max) {
                alert('æœ€å°æ’åä¸èƒ½å¤§äºæœ€å¤§æ’å');
                return;
            }
            
            // æ„é€  "min-max" æ ¼å¼å­—ç¬¦ä¸²ï¼Œä»¥ä¾¿å¤ç”¨ renderTable ä¸­çš„é€»è¾‘
            currentRankRange = `${min}-${max}`;
            currentPage = 1;
            renderTable(allTokens);
        }

        function goToPage(page) {
            // goToPage å†…éƒ¨è°ƒç”¨ renderTable æ—¶ä¼šè‡ªåŠ¨åº”ç”¨å½“å‰çš„è¿‡æ»¤æ¡ä»¶ (search & rank range)
            const searchValue = document.getElementById('search-input').value.toLowerCase();
            let filteredTokens = allTokens;
            
            if (currentRankRange !== 'all') {
                const [min, max] = currentRankRange.split('-').map(Number);
                filteredTokens = filteredTokens.filter(token => token.rank >= min && token.rank <= max);
            }
            
            filteredTokens = filteredTokens.filter(token =>
                token.name.toLowerCase().includes(searchValue) ||
                token.symbol.toLowerCase().includes(searchValue)
            );

            const totalPages = Math.ceil(filteredTokens.length / itemsPerPage);
            
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable(allTokens);
                document.querySelector('.max-w-screen-2xl').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function renderPaginationControls(totalItems) {
            const paginationContainer = document.getElementById('pagination-controls');
            paginationContainer.innerHTML = '';
            
            if (totalItems <= itemsPerPage) return; 

            const totalPages = Math.ceil(totalItems / itemsPerPage);

            const createPageButton = (pageNum, content) => {
                content = content !== undefined ? content : pageNum.toString();
                const isActive = pageNum === currentPage;
                const isEllipsis = content === '...';
                
                const btn = document.createElement('button');
                btn.innerHTML = content;
                
                let className = 'w-10 h-10 flex items-center justify-center rounded-xl text-base font-semibold transition duration-150 mx-0.5';
                if (isEllipsis) {
                    className += ' bg-transparent text-gray-500 cursor-default';
                    btn.disabled = true;
                } else if (isActive) {
                    className += ' bg-blue-600 text-white shadow-lg';
                    btn.disabled = true;
                } else {
                    className += ' bg-gray-800 text-white hover:bg-gray-700';
                    btn.onclick = () => goToPage(pageNum);
                }
                btn.className = className;
                return btn;
            }
            
            const createArrowButton = (pageNum, content, isEnabled) => {
                const arrow = document.createElement('button');
                arrow.innerHTML = content;
                const baseClass = 'w-8 h-8 flex items-center justify-center rounded-lg text-lg font-bold transition duration-200 cursor-pointer mx-2';
                arrow.className = baseClass + (isEnabled ? ' text-white hover:text-blue-400' : ' text-gray-600 cursor-not-allowed');
                arrow.disabled = !isEnabled;
                if (isEnabled) arrow.onclick = () => goToPage(pageNum);
                return arrow;
            }

            const prevArrow = createArrowButton(currentPage - 1, '<', currentPage > 1);
            paginationContainer.appendChild(prevArrow);

            let pagesToShow = [];
            const maxPagesAround = 2; 
            if (totalPages >= 1) pagesToShow.push(1);
            for (let i = currentPage - maxPagesAround; i <= currentPage + maxPagesAround; i++) {
                if (i > 1 && i < totalPages) pagesToShow.push(i);
            }
            if (totalPages > 1) pagesToShow.push(totalPages);
            pagesToShow = Array.from(new Set(pagesToShow)).sort((a, b) => a - b);
            
            let lastRenderedPage = 0;
            pagesToShow.forEach(p => {
                if (p > lastRenderedPage + 1) paginationContainer.appendChild(createPageButton(null, '...'));
                paginationContainer.appendChild(createPageButton(p));
                lastRenderedPage = p;
            });

            const nextArrow = createArrowButton(currentPage + 1, '>', currentPage < totalPages);
            paginationContainer.appendChild(nextArrow);
        }

        function renderTable(tokens = allTokens) {
            const tbody = document.getElementById('token-list-body');
            const searchValue = document.getElementById('search-input').value.toLowerCase();
            const colspan = 10;
            tbody.innerHTML = ''; 

            // === ä¿®æ”¹å¤„ï¼šå…ˆåº”ç”¨æ‰€æœ‰è¿‡æ»¤å™¨ ===
            let filteredTokens = tokens;

            // 1. æ’åèŒƒå›´è¿‡æ»¤ (Rank Range Filter)
            if (currentRankRange !== 'all') {
                const [minRank, maxRank] = currentRankRange.split('-').map(Number);
                filteredTokens = filteredTokens.filter(token => {
                    // token.rank å¯èƒ½ä¸º nullï¼Œå¤„ç†ä¸€ä¸‹å®‰å…¨
                    if (!token.rank) return false;
                    return token.rank >= minRank && token.rank <= maxRank;
                });
            }

            // 2. æœç´¢æ–‡æœ¬è¿‡æ»¤ (Search Filter)
            filteredTokens = filteredTokens.filter(token =>
                token.name.toLowerCase().includes(searchValue) ||
                token.symbol.toLowerCase().includes(searchValue)
            );
            
            // è°ƒæ•´å½“å‰é¡µç 
            const totalPages = Math.ceil(filteredTokens.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1;
            }

            if (filteredTokens.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="p-8 text-center text-gray-500">æœªæ‰¾åˆ°åŒ¹é…çš„ä»£å¸ (è¯·æ£€æŸ¥æ’åèŒƒå›´æˆ–æœç´¢è¯)ã€‚</td></tr>`;
                renderPaginationControls(0);
                return;
            }

            // åˆ†é¡µåˆ‡ç‰‡
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const tokensToRender = filteredTokens.slice(startIndex, endIndex);

            const financeDataClass = 'finance-data'; 

            tokensToRender.forEach(token => {
                const priceChange = token.priceChangePercent24h || 0;
                const changeClass = priceChange >= 0 ? 'percent-up' : 'percent-down';
                const changeText = priceChange ? priceChange.toFixed(2) + '%' : 'N/A';
                
                const row = document.createElement('tr');
                row.className = 'token-row transition duration-150';
                
                row.innerHTML += `<td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-400">${token.rank}</td>`;
                
                row.innerHTML += `
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <img src="${token.image}" alt="${token.symbol} logo" class="w-8 h-8 rounded-full mr-3" onerror="this.onerror=null;this.src='https://placehold.co/32x32/1e40af/ffffff?text=${token.symbol.substring(0, 1)}'">
                            <div class="truncate">
                                <div class="text-sm font-semibold text-white">${token.name}</div>
                                <div class="text-xs text-gray-500 uppercase">${token.symbol}</div>
                            </div>
                        </div>
                    </td>`;
                
                row.innerHTML += `<td class="px-4 py-4 ${financeDataClass} text-blue-300">${formatCurrency(token.priceUSD)}</td>`;

                const athPrice = token.ath;
                const athText = athPrice !== null && athPrice > 0 ? formatCurrency(athPrice) : 'N/A';
                const athColor = athPrice !== null && athPrice > 0 ? 'text-gray-300' : 'text-gray-500';
                
                row.innerHTML += `<td class="px-4 py-4 ${financeDataClass} ${athColor}">${athText}</td>`;

                const dropRatio = token.dropFromAthPercent;
                let dropRatioText = 'N/A';
                let dropRatioColor = 'text-gray-400';
                if (dropRatio !== null) {
                    dropRatioText = dropRatio.toFixed(2) + '%';
                    if (dropRatio > 90) dropRatioColor = 'text-red-500 font-bold';
                    else if (dropRatio > 70) dropRatioColor = 'text-red-400';
                    else if (dropRatio < 30) dropRatioColor = 'text-green-300';
                    else dropRatioColor = 'text-yellow-300';
                }
                
                row.innerHTML += `<td class="px-4 py-4 ${financeDataClass} ${dropRatioColor}">${dropRatioText}</td>`; 
                row.innerHTML += `<td class="px-4 py-4 ${financeDataClass} text-gray-300">${formatCompact(token.volume24hUSD)}</td>`;
                row.innerHTML += `<td class="px-4 py-4 ${financeDataClass} ${changeClass}">${changeText}</td>`;
                row.innerHTML += `<td class="px-4 py-4 ${financeDataClass} text-gray-300">${formatCompact(token.circulatingMarketCapUSD)}</td>`;

                let turnoverText;
                let turnoverColorClass;
                if (token.turnoverRate === null) {
                    turnoverText = 'N/A';
                    turnoverColorClass = 'text-gray-500'; 
                } else {
                    turnoverText = token.turnoverRate.toFixed(2) + '%';
                    turnoverColorClass = token.turnoverRate > 30 ? 'text-pink-400' : token.turnoverRate > 10 ? 'text-blue-300' : 'text-gray-400';
                }

                row.innerHTML += `<td class="px-4 py-4 ${financeDataClass} ${turnoverColorClass}">${turnoverText}</td>`;
                
                const sectorColor = token.sector === 'N/A' ? 'text-gray-500' : 'text-gray-300';
                row.innerHTML += `<td class="px-4 py-4 whitespace-nowrap text-sm ${sectorColor}">${token.sector}</td>`;

                tbody.appendChild(row);
            });
            
            renderPaginationControls(filteredTokens.length);
        }

        async function fetchDataAndRender() {
            try {
                currentPage = 1; 
                const tbody = document.getElementById('token-list-body');
                tbody.innerHTML = '<tr><td colspan="10" class="p-8 text-center text-gray-500">æ­£åœ¨ä» API è·å–æ•°æ®...</td></tr>';
                document.getElementById('pagination-controls').innerHTML = '';

                const fetchedTokens = await fetchTokenData();
                allTokens = fetchedTokens;

                currentSort = { column: 'rank', direction: 'asc' }; 
                allTokens.sort((a, b) => {
                    const aVal = a.rank || Infinity;
                    const bVal = b.rank || Infinity;
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                });
                
                renderTable(allTokens); 

            } catch (error) {
                console.error("åŠ è½½æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:", error);
                const tbody = document.getElementById('token-list-body');
                tbody.innerHTML = `<tr><td colspan="10" class="p-8 text-center text-red-400">æ•°æ®åŠ è½½å¤±è´¥ï¼š${error.message}ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦æƒ…ã€‚</td></tr>`;
                document.getElementById('pagination-controls').innerHTML = '';
            }
        }

        function initialize() {
            const refreshRate = 14400000; 
            fetchDataAndRender();
            refreshIntervalId = setInterval(fetchDataAndRender, refreshRate);
            console.log(`å·²è®¾ç½®æ¯ ${refreshRate / 3600000} å°æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®ã€‚`);
        }

        document.getElementById('search-input').addEventListener('input', () => {
            currentPage = 1; 
            renderTable(allTokens);
        });

        window.onload = initialize;

    </script>
</body>
</html>